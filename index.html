<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pesticides in Agriculture Dashboard — Report Aligned</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f5f7f9; color: #333; line-height: 1.6; }
    .container { max-width: 1280px; margin: 0 auto; padding: 20px; }
    header { background: linear-gradient(135deg, #2c7744, #5aaf70); color: white; padding: 30px 20px; text-align: center; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 8px 24px rgba(44,119,68,0.2); }
    h1 { font-size: 2.5rem; margin-bottom: 12px; font-weight: 700; }
    .subtitle { font-size: 1.1rem; opacity: 0.95; font-weight: 300; }
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); text-align: center; transition: transform 0.2s ease; }
    .card:hover { transform: translateY(-4px); }
    .card h3 { color: #2c7744; margin-bottom: 8px; font-size: 1.1rem; font-weight: 600; }
    .card .value { font-size: 2rem; font-weight: 700; color: #1a4d2e; margin: 8px 0; }
    .card .description { font-size: 0.9rem; color: #666; line-height: 1.4; }
    .chart-container { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    .chart-title { text-align: center; margin-bottom: 20px; color: #2c7744; font-size: 1.3rem; font-weight: 600; }
    .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 900px) { .chart-row { grid-template-columns: 1fr; } }
    .footer { text-align: center; margin-top: 30px; padding: 24px; color: #666; font-size: 0.9rem; background: white; border-radius: 12px; }
    .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin: 20px 0; }
    .control-btn { padding: 12px 20px; background: linear-gradient(135deg, #2c7744, #3d7a57); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; font-size: 0.95rem; }
    .control-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(44,119,68,0.3); }
    .control-btn.secondary { background: linear-gradient(135deg, #5a5a5a, #757575); }
    .insights { background: linear-gradient(135deg, #e8f4ec, #f0f8f2); border-left: 5px solid #2c7744; padding: 16px; margin: 16px 0 0; border-radius: 8px; }
    .insights h4 { color: #1a4d2e; margin-bottom: 8px; font-weight: 600; }
    .insights p { color: #2d5a3d; line-height: 1.5; }
    .pill { display: inline-block; padding: 4px 12px; border-radius: 16px; font-size: 0.75rem; background: linear-gradient(135deg, #eef7f0, #e8f4ec); color: #1a4d2e; margin-left: 10px; font-weight: 600; }
    table.matrix { border-collapse: collapse; width: 100%; margin: 10px 0; }
    table.matrix th, table.matrix td { border: 1px solid #e0e0e0; padding: 8px 10px; text-align: center; font-size: 0.85rem; }
    table.matrix th { background: #f8f9fa; font-weight: 600; color: #2c7744; }
    .legend { font-size: 0.85rem; color: #666; text-align: right; margin-top: 8px; font-style: italic; }
    .small { font-size: 0.9rem; color: #555; }
    .note { font-size: 0.85rem; color: #666; margin-top: 8px; line-height: 1.4; }
    .methodology { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin: 16px 0; }
    .methodology h4 { color: #495057; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Pesticides in Agriculture & Food Price Inflation</h1>
      <p class="subtitle">South Africa Agricultural Analysis (2000–2023) • NDTA 631 Group Assignment • FAO Data Analysis</p>
      <div style="margin-top: 15px; font-size: 0.9rem;">
        Group Members: Malatji Lerato, Kateko Mgabe, Esther Olusanya, Qolani Moloi, Katlego Mpetsheni
      </div>
    </header>

    <div class="summary-cards" id="summaryCards">
      <div class="card">
        <h3>Average Pesticide Usage</h3>
        <div class="value" id="avgPesticide">—</div>
        <div class="description">Mean annual usage with CV ≈ <span id="cvPesticide">—</span><br><small>(Report: ~20,000t, CV≈12%)</small></div>
      </div>
      <div class="card">
        <h3>Annual Growth Trend</h3>
        <div class="value">+150 t/yr</div>
        <div class="description">Linear regression slope<br><small>Sustained long-term growth</small></div>
      </div>
      <div class="card">
        <h3>Mean Annual Growth</h3>
        <div class="value">+1.2%</div>
        <div class="description">Average yearly increase<br><small>With volatility spikes/troughs</small></div>
      </div>
      <div class="card">
        <h3>Pesticide-Production Correlation</h3>
        <div class="value" id="corrPT">—</div>
        <div class="description">Moderate positive association<br><small>Target: ≈+0.45 (Report)</small></div>
      </div>
      <div class="card">
        <h3>Distribution Analysis</h3>
        <div class="value">Non-Normal</div>
        <div class="description">Shapiro-Wilk: p < 0.05<br><small>Severe skew indicated</small></div>
      </div>
      <div class="card">
        <h3>Dominant Crop</h3>
        <div class="value">Sugarcane</div>
        <div class="description">~20 million tonnes/year<br><small>Overshadows other crops</small></div>
      </div>
    </div>

    <div class="controls">
      <button class="control-btn" id="btnRegen">Regenerate Simulation</button>
      <button class="control-btn secondary" id="btnToggleMissing">Toggle: Raw ↔ Cleaned Data</button>
      <button class="control-btn" id="btnDownload">Export Excel (SA_Agriculture_Analysis.xlsx)</button>
    </div>

    <!-- Section 4.1: Pesticide Use Over Time -->
    <div class="chart-container">
      <h2 class="chart-title">4.1 Pesticide Usage Over Time (2000–2023) <span class="pill">Report §4.1</span></h2>
      <canvas id="pesticideChart"></canvas>
      <div class="insights">
        <h4>Key Findings (Per Report)</h4>
        <p>Definite upward trend with significant short-term fluctuations. Notable decline during mid-2000s versus rapid growth post-2015. Linear regression shows +150 tonnes annually increase.</p>
      </div>
      <div class="methodology">
        <h4>Methodology</h4>
        <p>Missing values handled through forward/backward fill interpolation. Statistical analysis using NumPy, Pandas, and SciPy.</p>
      </div>
    </div>

    <!-- Section 4.2: Crop Production Trends -->
    <div class="chart-container">
      <h2 class="chart-title">4.2 Crop Production Trends by Individual Crop <span class="pill">Report §4.2</span></h2>
      <canvas id="cropChart"></canvas>
      <div class="insights">
        <h4>Report Findings</h4>
        <p><strong>Sugarcane:</strong> Always ahead in production quantities, overshadowing others<br>
        <strong>Maize:</strong> Consistent growth as a staple crop<br>
        <strong>Soybeans & Sunflower:</strong> High year-over-year volatility, sensitive to climate and market conditions</p>
      </div>
    </div>

    <!-- Section 4.3: Cumulative Production -->
    <div class="chart-row">
      <div class="chart-container">
        <h2 class="chart-title">4.3 Cumulative Crop Production Over Time <span class="pill">Report §4.3</span></h2>
        <canvas id="totalCropChart"></canvas>
        <div class="insights">
          <h4>Analysis</h4>
          <p>Overall trend of total production despite fluctuations. Steady upward trend suggests general increase in agricultural productivity. Peaks and valleys reflect drought spells and technological improvements.</p>
        </div>
      </div>
      
      <!-- Section 4.4: Annual Spread -->
      <div class="chart-container">
        <h2 class="chart-title">4.4 Annual Production Spread Analysis <span class="pill">Report §4.4</span></h2>
        <canvas id="boxplotChart"></canvas>
        <div class="insights">
          <h4>Volatility Assessment</h4>
          <p>Variation among crops with varying spreads. Some years show outliers (unusually high/low production). Year-to-year volatility significant for less dominant crops.</p>
        </div>
      </div>
    </div>

    <!-- Section 5.4: Statistical Analysis -->
    <div class="chart-row">
      <div class="chart-container">
        <h2 class="chart-title">5.4 Trend Comparison: Inputs vs Outputs <span class="pill">Report §5.4</span></h2>
        <canvas id="trendCompare"></canvas>
        <div class="insights">
          <h4>Parallel Trends Analysis</h4>
          <p>Both inputs (pesticides) and outputs (total crops) show long-term increases. Production exhibits higher volatility than pesticide usage, reflecting agricultural sensitivity to external factors.</p>
        </div>
      </div>
      
      <div class="chart-container">
        <h2 class="chart-title">Correlation Analysis & Regression Model <span class="pill">Report §5.3</span></h2>
        <canvas id="correlationChart"></canvas>
        <div class="insights">
          <h4>Statistical Relationship</h4>
          <p>Moderate positive correlation (target ≈+0.45). Regression model: Production = slope × Pesticides + intercept. Quantifiable but limited prediction relationship.</p>
        </div>
      </div>
    </div>

    <!-- Correlation Heatmap -->
    <div class="chart-container">
      <h2 class="chart-title">Crop Correlation Matrix (Pairwise Analysis) <span class="pill">Report §5.4</span></h2>
      <div id="corrHeatmap"></div>
      <div class="legend">Correlation Scale: -1.0 (red) → 0.0 (white) → +1.0 (green)</div>
      <div class="insights">
        <h4>Inter-Crop Relationships</h4>
        <p>Stronger correlations between some crops (e.g., Maize and Sugarcane) and weaker correlations between others (e.g., Sunflower). Reflects different sensitivities to climate and market conditions.</p>
      </div>
    </div>

    <!-- Section 4.5: Data Quality -->
    <div class="chart-container">
      <h2 class="chart-title">4.5 Data Quality Assessment: Missing Values Analysis <span class="pill">Report §4.5 & §5.2</span></h2>
      <div id="missingHeatmap" class="small"></div>
      <div class="note">
        <strong>Data Cleaning Process:</strong> Red cells indicate missing values in original FAO datasets. 
        Missing pesticide values imputed using forward/backward fill. 
        Missing crop values imputed using crop-wise means. 
        Toggle button shows raw vs. cleaned data views.
      </div>
      <div class="methodology">
        <h4>Cleaning Methodology (Section 5.2)</h4>
        <p><strong>Pesticides:</strong> Forward and backward fill to ensure time-series continuity<br>
        <strong>Crops:</strong> Mean imputation per crop to maintain individual crop patterns<br>
        <strong>Validation:</strong> Post-cleaning verification confirmed all missing values addressed</p>
      </div>
    </div>

    <div class="footer">
      <h3 style="color: #2c7744; margin-bottom: 10px;">Study Summary</h3>
      <p><strong>Data Sources:</strong> FAO_CP_23014.csv (Crop Production) & FAO_RP_5157.csv (Pesticide Usage)</p>
      <p><strong>Analysis Period:</strong> 2000–2023 (24 years) • <strong>Study Focus:</strong> Pesticide-Production Relationship in South African Agriculture</p>
      <p><strong>Key Statistical Tools:</strong> NumPy, Pandas, SciPy, Matplotlib, Seaborn • <strong>Export Format:</strong> SA_Agriculture_Analysis.xlsx</p>
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
        <strong>Programme:</strong> Diploma in ICT • <strong>Module:</strong> Data Analysis and Visualisation (NDTA 631)
      </div>
    </div>
  </div>

  <script>
    // Data simulation parameters aligned with report findings
    const years = Array.from({ length: 24 }, (_, i) => 2000 + i);
    const crops = ['Maize', 'Wheat', 'Sugarcane', 'Sunflower', 'Soybeans'];

    // Statistical helpers
    const randn = () => {
      let u = 0, v = 0;
      while (u === 0) u = Math.random();
      while (v === 0) v = Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    };
    
    const mean = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
    const stdev = arr => {
      const m = mean(arr);
      return Math.sqrt(arr.reduce((s,x)=>s+(x-m)*(x-m),0)/(arr.length-1));
    };
    const coeffVar = arr => stdev(arr)/mean(arr);
    const pearson = (x,y) => {
      const mx = mean(x), my = mean(y);
      let num=0, dx=0, dy=0;
      for (let i=0; i<x.length; i++) {
        const a = x[i] - mx;
        const b = y[i] - my;
        num += a * b;
        dx += a * a;
        dy += b * b;
      }
      return num / Math.sqrt(dx * dy);
    };

    // Report-aligned simulation parameters
    const basePesticide = 19850; // To achieve ~20,000t average
    const trend = 150;           // +150 t/year (exact from report)
    const variability = 2400;    // To achieve ~12% CV

    // Crop parameters (aligned with report findings)
    const baseProduction = {
      Maize: 8500,      // Consistent growth staple
      Wheat: 1800,      // Key bread cereal
      Sugarcane: 19500, // Dominant crop ~20M tonnes
      Sunflower: 650,   // Volatile oilseed
      Soybeans: 1100    // Growing protein crop
    };

    const cropTrends = {
      Maize: 1.025,     // Steady consistent growth
      Wheat: 1.008,     // Slow growth
      Sugarcane: 1.035, // Strong growth (cash crop)
      Sunflower: 1.002, // Minimal trend (volatile)
      Soybeans: 1.055   // Strong growth (increasing importance)
    };

    const cropVolatility = {
      Maize: 0.12,      // Stable staple
      Wheat: 0.18,      // Moderate volatility
      Sugarcane: 0.08,  // Most stable (industrial)
      Sunflower: 0.45,  // High volatility (report noted)
      Soybeans: 0.38    // High volatility (report noted)
    };

    // Data generation with realistic missing value patterns
    function buildData(withImputation) {
      // Generate pesticide data with report characteristics
      let pesticidesRaw = years.map((_, i) => {
        let val = basePesticide + trend * i + variability * randn() * 0.4;
        
        // Report-specific patterns
        if (i >= 4 && i <= 7) val *= 0.82;  // Mid-2000s decline
        if (i >= 15) val *= 1.08;           // Post-2015 rapid growth
        if (i === 3 || i === 12) val *= 0.75; // Specific low years
        
        return Math.max(1000, Math.round(val));
      });

      // Inject missing values (realistic FAO data gaps)
      const pestMissingIdx = [2, 8, 15, 19];
      pestMissingIdx.forEach(i => pesticidesRaw[i] = null);

      // Generate crop data
      const cropRaw = {};
      crops.forEach(c => {
        cropRaw[c] = years.map((_, i) => {
          let v = baseProduction[c] * Math.pow(cropTrends[c], i);
          v *= (1 + cropVolatility[c] * randn() * 0.6);
          
          // Climate/market shocks (drought years, etc.)
          if (i === 2 || i === 7 || i === 15) v *= 0.65; // Drought years
          if (i === 5 || i === 18) v *= 1.25; // Good years
          
          return Math.max(50, Math.round(v));
        });
      });

      // Realistic missing patterns for crops
      const missMap = {
        Maize: [4, 11],
        Wheat: [6, 13, 20],
        Sugarcane: [3, 16],
        Sunflower: [9, 14, 21],
        Soybeans: [7, 17]
      };
      
      Object.entries(missMap).forEach(([c, idxs]) => {
        idxs.forEach(i => { cropRaw[c][i] = null; });
      });

      // Apply imputation methods from report
      const pesticides = withImputation ? imputeForwardBackward(pesticidesRaw) : pesticidesRaw.slice();
      const cropData = {};
      crops.forEach(c => {
        cropData[c] = withImputation ? imputeMean(cropRaw[c]) : cropRaw[c].slice();
      });

      return { pesticidesRaw, cropRaw, pesticides, cropData };
    }

    // Imputation methods (per report methodology)
    function imputeForwardBackward(arr) {
      const a = arr.slice();
      // Forward fill
      for (let i = 1; i < a.length; i++) {
        if (a[i] == null && a[i-1] != null) a[i] = a[i-1];
      }
      // Backward fill
      for (let i = a.length - 2; i >= 0; i--) {
        if (a[i] == null && a[i+1] != null) a[i] = a[i+1];
      }
      return a.map(v => v == null ? 0 : v);
    }

    function imputeMean(arr) {
      const vals = arr.filter(v => v != null);
      const m = mean(vals);
      return arr.map(v => v == null ? Math.round(m) : v);
    }

    // Color mapping for correlation heatmap
    function corrColor(v) {
      const clamp = (x, min, max) => Math.max(min, Math.min(max, x));
      if (v >= 0) {
        const intensity = Math.floor(255 * v);
        return `rgb(${255-intensity},255,${255-intensity})`;
      } else {
        const intensity = Math.floor(255 * Math.abs(v));
        return `rgb(255,${255-intensity},${255-intensity})`;
      }
    }

    // Initialize data
    let withImputation = true;
    let { pesticidesRaw, cropRaw, pesticides, cropData } = buildData(withImputation);
    let totalProduction = years.map((_, i) => 
      crops.reduce((s, c) => s + (cropData[c][i] || 0), 0)
    );

    // Chart objects
    let charts = {};

    // Update KPIs
    function refreshKPIs() {
      const validPest = pesticides.filter(v => v != null && !isNaN(v));
      const avg = Math.round(mean(validPest));
      const cv = coeffVar(validPest);
      
      document.getElementById('avgPesticide').textContent = avg.toLocaleString() + ' t';
      document.getElementById('cvPesticide').textContent = (cv * 100).toFixed(1) + '%';
      
      const validTotal = totalProduction.filter(v => v != null && !isNaN(v));
      const r = pearson(validPest, validTotal);
      document.getElementById('corrPT').textContent = r.toFixed(2);
    }

    // Chart creation functions
    function makePesticideChart() {
      const ctx = document.getElementById('pesticideChart').getContext('2d');
      charts.pesticideChart?.destroy();
      
      charts.pesticideChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [{
            label: 'Pesticide Usage (tonnes)',
            data: pesticides,
            borderColor: '#2c7744',
            backgroundColor: 'rgba(44,119,68,0.15)',
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Pesticide Usage Trend: +150t/yr Linear Growth',
              font: { size: 14, weight: 'bold' }
            },
            tooltip: {
              callbacks: {
                label: (c) => `${c.label}: ${c.formattedValue} tonnes`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: 'Pesticide Usage (tonnes)',
                font: { weight: 'bold' }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Year',
                font: { weight: 'bold' }
              }
            }
          }
        }
      });
    }

    function makeCropChart() {
      const ctx = document.getElementById('cropChart').getContext('2d');
      charts.cropChart?.destroy();
      
      const colors = {
        'Maize': '#FF6B6B',
        'Wheat': '#4ECDC4', 
        'Sugarcane': '#45B7D1',
        'Sunflower': '#FFA07A',
        'Soybeans': '#98D8C8'
      };
      
      charts.cropChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: crops.map(c => ({
            label: c,
            data: cropData[c],
            borderColor: colors[c],
            backgroundColor: colors[c] + '20',
            borderWidth: 2.5,
            tension: 0.2,
            pointRadius: 3
          }))
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Individual Crop Production Trends (Sugarcane Dominates)',
              font: { size: 14, weight: 'bold' }
            }
          },
          scales: {
            y: {
              title: {
                display: true,
                text: 'Production (tonnes)',
                font: { weight: 'bold' }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Year',
                font: { weight: 'bold' }
              }
            }
          }
        }
      });
    }

    function makeTotalChart() {
      const ctx = document.getElementById('totalCropChart').getContext('2d');
      charts.totalChart?.destroy();
      
      charts.totalChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [{
            label: 'Total Crop Production',
            data: totalProduction,
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54,162,235,0.15)',
            borderWidth: 3,
            fill: true,
            tension: 0.25,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Cumulative Agricultural Production (All Crops)',
              font: { size: 14, weight: 'bold' }
            }
          },
          scales: {
            y: {
              title: {
                display: true,
                text: 'Total Production (tonnes)',
                font: { weight: 'bold' }
              }
            }
          }
        }
      });
    }

    function makeBoxProxy() {
      const stats = years.map((_, i) => {
        const vals = crops.map(c => cropData[c][i]).filter(v => v != null);
        vals.sort((a, b) => a - b);
        const len = vals.length;
        return {
          min: vals[0],
          q1: vals[Math.floor(len * 0.25)],
          median: vals[Math.floor(len * 0.5)],
          q3: vals[Math.floor(len * 0.75)],
          max: vals[len - 1]
        };
      });
      
      const ctx = document.getElementById('boxplotChart').getContext('2d');
      charts.boxplotChart?.destroy();
      
      charts.boxplotChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            { label: 'Min', data: stats.map(s => s.min), borderColor: '#FF6B6B', fill: false },
            { label: 'Q1', data: stats.map(s => s.q1), borderColor: '#4ECDC4', fill: false },
            { label: 'Median', data: stats.map(s => s.median), borderColor: '#45B7D1', fill: false, borderWidth: 3 },
            { label: 'Q3', data: stats.map(s => s.q3), borderColor: '#FFA07A', fill: false },
            { label: 'Max', data: stats.map(s => s.max), borderColor: '#98D8C8', fill: false }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Annual Production Spread (Quartile Analysis)',
              font: { size: 14, weight: 'bold' }
            }
          },
          scales: {
            y: {
              title: {
                display: true,
                text: 'Production Range (tonnes)',
                font: { weight: 'bold' }
              }
            }
          }
        }
      });
    }

    function makeTrendCompare() {
      const ctx = document.getElementById('trendCompare').getContext('2d');
      charts.trendCompare?.destroy();
      
      charts.trendCompare = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            {
              label: 'Pesticides (tonnes)',
              data: pesticides,
              borderColor: '#2c7744',
              backgroundColor: 'rgba(44,119,68,0.1)',
              tension: 0.25,
              fill: false,
              borderWidth: 3,
              yAxisID: 'y'
            },
            {
              label: 'Total Production (tonnes)',
              data: totalProduction,
              borderColor: '#36A2EB',
              backgroundColor: 'rgba(54,162,235,0.1)',
              tension: 0.25,
              fill: false,
              borderWidth: 3,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Parallel Trend Analysis: Inputs vs Outputs',
              font: { size: 14, weight: 'bold' }
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Pesticides (tonnes)',
                font: { weight: 'bold' }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Total Production (tonnes)',
                font: { weight: 'bold' }
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    function linReg(x, y) {
      const n = x.length;
      const mx = mean(x), my = mean(y);
      let num = 0, den = 0;
      for (let i = 0; i < n; i++) {
        num += (x[i] - mx) * (y[i] - my);
        den += (x[i] - mx) * (x[i] - mx);
      }
      const slope = num / den;
      const intercept = my - slope * mx;
      return { slope, intercept };
    }

    function makeCorrelation() {
      const ctx = document.getElementById('correlationChart').getContext('2d');
      charts.corrChart?.destroy();
      
      const pts = years.map((_, i) => ({
        x: pesticides[i],
        y: totalProduction[i]
      }));
      
      const { slope, intercept } = linReg(pesticides, totalProduction);
      const xs = [Math.min(...pesticides), Math.max(...pesticides)];
      const regLine = xs.map(x => ({ x, y: slope * x + intercept }));
      
      charts.corrChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Data Points',
              data: pts,
              backgroundColor: 'rgba(44,119,68,0.7)',
              pointRadius: 6,
              pointHoverRadius: 8
            },
            {
              label: `Regression Line (slope: ${slope.toFixed(3)})`,
              data: regLine,
              type: 'line',
              borderColor: '#FF6384',
              fill: false,
              pointRadius: 0,
              borderWidth: 3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Pesticide-Production Correlation & Regression',
              font: { size: 14, weight: 'bold' }
            },
            tooltip: {
              callbacks: {
                label: (c) => {
                  if (c.datasetIndex === 0) {
                    return `(${c.raw.x.toLocaleString()} t, ${c.raw.y.toLocaleString()} t)`;
                  } else {
                    return c.dataset.label;
                  }
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Pesticide Usage (tonnes)',
                font: { weight: 'bold' }
              }
            },
            y: {
              title: {
                display: true,
                text: 'Total Crop Production (tonnes)',
                font: { weight: 'bold' }
              }
            }
          }
        }
      });
    }

    function makeCorrHeatmap() {
      const container = document.getElementById('corrHeatmap');
      container.innerHTML = '';
      
      // Build correlation matrix among crops
      const matrix = crops.map(() => Array(crops.length).fill(1));
      for (let i = 0; i < crops.length; i++) {
        for (let j = i; j < crops.length; j++) {
          const a = cropData[crops[i]];
          const b = cropData[crops[j]];
          const r = i === j ? 1 : pearson(a, b);
          matrix[i][j] = matrix[j][i] = r;
        }
      }
      
      const table = document.createElement('table');
      table.className = 'matrix';
      
      // Header row
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headerRow.appendChild(document.createElement('th'));
      crops.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Data rows
      const tbody = document.createElement('tbody');
      for (let i = 0; i < crops.length; i++) {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = crops[i];
        tr.appendChild(th);
        
        for (let j = 0; j < crops.length; j++) {
          const td = document.createElement('td');
          const v = matrix[i][j];
          td.textContent = i === j ? '1.00' : v.toFixed(2);
          td.style.backgroundColor = corrColor(v);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function makeMissingHeatmap() {
      const container = document.getElementById('missingHeatmap');
      container.innerHTML = '';
      
      const vars = ['Pesticides', ...crops];
      const rawMap = { 'Pesticides': pesticidesRaw, ...cropRaw };
      const imputedMap = { 'Pesticides': pesticides, ...cropData };
      const source = withImputation ? imputedMap : rawMap;
      
      const table = document.createElement('table');
      table.className = 'matrix';
      
      // Header
      const thead = document.createElement('thead');
      const hr = document.createElement('tr');
      const headerTh = document.createElement('th');
      headerTh.textContent = withImputation ? 'Variable (Cleaned)' : 'Variable (Raw)';
      hr.appendChild(headerTh);
      
      years.forEach(y => {
        const th = document.createElement('th');
        th.textContent = y;
        hr.appendChild(th);
      });
      thead.appendChild(hr);
      table.appendChild(thead);
      
      // Data rows
      const tbody = document.createElement('tbody');
      vars.forEach(v => {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = v;
        tr.appendChild(th);
        
        years.forEach((_, i) => {
          const td = document.createElement('td');
          const missing = source[v][i] == null || Number.isNaN(source[v][i]);
          td.style.backgroundColor = missing ? '#ffcccc' : '#ffffff';
          td.textContent = missing ? '' : '•';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function rebuildAll() {
      // Destroy existing charts
      Object.values(charts).forEach(chart => chart?.destroy?.());
      
      // Recompute totals
      totalProduction = years.map((_, i) =>
        crops.reduce((s, c) => s + (cropData[c][i] || 0), 0)
      );
      
      refreshKPIs();
      makePesticideChart();
      makeCropChart();
      makeTotalChart();
      makeBoxProxy();
      makeTrendCompare();
      makeCorrelation();
      makeCorrHeatmap();
      makeMissingHeatmap();
    }

    // Excel export function
    function exportExcel() {
      const wb = XLSX.utils.book_new();
      
      // Pesticides sheet
      const pestRows = years.map((y, i) => ({
        Year: y,
        Pesticide_Usage_Tonnes: pesticides[i]
      }));
      const ws1 = XLSX.utils.json_to_sheet(pestRows);
      XLSX.utils.book_append_sheet(wb, ws1, 'Pesticides');
      
      // Crops sheet (long format)
      const cropRows = [];
      years.forEach((y, i) => {
        crops.forEach(c => {
          cropRows.push({
            Year: y,
            Crop: c,
            Production_Tonnes: cropData[c][i]
          });
        });
      });
      const ws2 = XLSX.utils.json_to_sheet(cropRows);
      XLSX.utils.book_append_sheet(wb, ws2, 'Crops');
      
      XLSX.writeFile(wb, 'SA_Agriculture_Analysis.xlsx');
    }

    // Event listeners
    document.getElementById('btnRegen').addEventListener('click', () => {
      ({ pesticidesRaw, cropRaw, pesticides, cropData } = buildData(withImputation));
      rebuildAll();
    });

    document.getElementById('btnToggleMissing').addEventListener('click', () => {
      withImputation = !withImputation;
      ({ pesticidesRaw, cropRaw, pesticides, cropData } = buildData(withImputation));
      rebuildAll();
    });

    document.getElementById('btnDownload').addEventListener('click', exportExcel);

    // Initialize dashboard
    rebuildAll();
  </script>
</body>
</html>